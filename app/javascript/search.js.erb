$(document).ready(function () {
  const apiKey = "bde4044cbeac4accb71e78d2aa890b69";
  
  // Only add CSRF token for internal requests (to your Rails app)
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  // Add CSRF token only for requests to your Rails server
  $.ajaxSetup({
    beforeSend: function (xhr, settings) {
      if (settings.url.includes(window.location.origin)) {
        xhr.setRequestHeader('X-CSRF-Token', csrfToken);
      }
    }
  });

  // Search button click handler
  $("#search-button").on("click", function () {
    const ingredient = $("#ingredient").val().trim();
    
    if (ingredient) {
      fetchRecipes(ingredient, apiKey);
    } else {
      alert("Please enter an ingredient.");
    }
  });

  // Define the fetchRecipes function to fetch recipes based on the ingredient
  function fetchRecipes(ingredient, apiKey) {
    $.ajax({
      url: `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${ingredient}&apiKey=${apiKey}`,
      method: 'GET',
      success: function (recipes) {
        console.log(recipes); // Log the recipes to verify the API response
        
        // Call another function to display the recipes (you can reuse the code to display detailed recipe information here)
        fetchDetailedRecipes(recipes, apiKey);
      },
      error: function () {
        alert("Error fetching recipes.");
      }
    });
  }

  // Function to display detailed recipes (you already have this function)
  function fetchDetailedRecipes(recipes, apiKey) {
    let recipeHtml = "";

    recipes.forEach(function (recipe) {
      $.ajax({
        url: `https://api.spoonacular.com/recipes/${recipe.id}/information?apiKey=${apiKey}`,
        method: "GET",
        success: function (recipeDetails) {
          recipeHtml += `
            <div class="recipe" 
                 data-recipe-id="${recipeDetails.id}"
                 data-recipe-title="${recipeDetails.title}"
                 data-recipe-image="${recipeDetails.image}"
                 data-recipe-instructions="${recipeDetails.instructions}"
                 data-recipe-ingredients='${JSON.stringify(recipeDetails.extendedIngredients)}'>
              <h3>${recipeDetails.title}</h3>
              <img src="${recipeDetails.image}" alt="${recipeDetails.title}" />
              <p><strong>Ingredients:</strong></p>
              <ul>
                ${recipeDetails.extendedIngredients.map(function (ingredient) {
                  return `<li>${ingredient.amount} ${ingredient.unit} ${ingredient.name}</li>`;
                }).join('')}
              </ul>
              <p><strong>Instructions:</strong></p>
              <p>${recipeDetails.instructions}</p>
              <button class="save-recipe" data-recipe-id="${recipeDetails.id}">Save Recipe</button>
          `;
  
          if (recipeDetails.nutrition && recipeDetails.nutrition.nutrients && recipeDetails.nutrition.nutrients[0]) {
            recipeHtml += `<p><strong>Nutrition:</strong> Calories: ${recipeDetails.nutrition.nutrients[0].amount} ${recipeDetails.nutrition.nutrients[0].unit}</p>`;
          } else {
            recipeHtml += `<p><strong>Nutrition:</strong> Information not available.</p>`;
          }
  
          recipeHtml += `</div>`;
  
          if (recipeHtml) {
            $("#recipes-list").html(recipeHtml);
          }
        },
        error: function () {
          recipeHtml += `<p>Failed to load detailed recipe information for ${recipe.title}.</p>`;
        }
      });
    });
  }

  // Save button click handler (as per your earlier code)
  $(document).on('click', '.save-recipe', function () {
    const recipeElement = $(this).closest('.recipe');
    const recipeId = recipeElement.data('recipe-id');
    const userId = document.querySelector('meta[name="user-id"]')?.getAttribute('content');
    const recipeTitle = recipeElement.data('recipe-title');
    const recipeImage = recipeElement.data('recipe-image');
    const recipeInstructions = recipeElement.data('recipe-instructions');
    const ingredients = JSON.parse(recipeElement.data('recipe-ingredients'));

    $.ajax({
      url: '/recipes/save',
      method: 'POST',
      data: {
        recipe_id: recipeId,
        user_id: userId,
        title: recipeTitle,
        image: recipeImage,
        instructions: recipeInstructions,
        ingredients: ingredients.map(function (ingredient) {
          return {
            name: ingredient.name,
            quantity: ingredient.amount,
            unit: ingredient.unit
          };
        })
      },
      success: function(response) {
        alert('Recipe saved!');
      },
      error: function() {
        alert('Failed to save the recipe.');
      }
    });
  });
});
